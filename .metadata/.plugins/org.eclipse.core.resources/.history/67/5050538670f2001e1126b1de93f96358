#include "API_uart.h"

/* UART handler declaration */
UART_HandleTypeDef UartHandle;

// Private variables
static const char config[] = "\n\rUART config: 9600bps 8N1\n\r";

// Function Prototypes
static void uartErrorHandler();
void printUARTConfiguration(UART_HandleTypeDef UartHandle);

//Configure the UART peripheral
bool_t uartInit() {

	bool_t isConnectionSuccesfull = true;

	UartHandle.Instance = USARTx; //Put the USART peripheral in the Asynchronous mode (UART Mode)
	UartHandle.Init.BaudRate = 9600;                   // BaudRate configuration
	UartHandle.Init.WordLength = UART_WORDLENGTH_8B; // Word Length = 8 Bits (7 data bit + 1 parity bit) :
													 // BE CAREFUL : Program 7 data bits + 1 parity bit in PC HyperTerminal
	UartHandle.Init.StopBits = UART_STOPBITS_1;     // One Stop bit
	UartHandle.Init.Parity = UART_PARITY_ODD;      // ODD parity
	UartHandle.Init.HwFlowCtl = UART_HWCONTROL_NONE; // Hardware flow control disabled (RTS and CTS signals)
	UartHandle.Init.Mode = UART_MODE_TX_RX;   // Transmission and reception mode
	UartHandle.Init.OverSampling = UART_OVERSAMPLING_16;	// Oversampling = 16

	if (HAL_UART_Init(&UartHandle) != HAL_OK) {
		uartErrorHandler();
		isConnectionSuccesfull = false;
	}else {
		printUARTConfiguration(UartHandle);
	}
	return isConnectionSuccesfull;
}

void uartSendString(uint8_t *pstring) {
	if (pstring == NULL) {
		uartErrorHandler();
	}
	while (*pstring != '\0') {
		HAL_UART_Transmit(&UartHandle, pstring++, 1, HAL_MAX_DELAY);
	}
}

void uartSendStringSize(uint8_t *pstring, uint16_t size) {
	if (pstring == NULL) {
		uartErrorHandler();
	}
	for (uint16_t i = 0; i < size; i++) {
		HAL_UART_Transmit(&UartHandle, pstring++, 1, HAL_MAX_DELAY);
	}
}
void uartReceiveStringSize(uint8_t *pstring, uint16_t size);

void printUARTConfiguration(UART_HandleTypeDef UartHandle) {
    // Imprimir los parámetros de configuración por la terminal serie
    printf("Configuración del UART:\n");
    printf("BaudRate: %lu\n", UartHandle.Init.BaudRate);
    printf("WordLength: %d bits\n", (UartHandle.Init.WordLength == UART_WORDLENGTH_8B) ? 8 : 9); // La longitud de palabra podría ser de 8 o 9 bits
    printf("StopBits: %s\n", (UartHandle.Init.StopBits == UART_STOPBITS_1) ? "1 bit" : "2 bits");
    printf("Parity: %s\n", (UartHandle.Init.Parity == UART_PARITY_NONE) ? "Ninguno" : (UartHandle.Init.Parity == UART_PARITY_EVEN) ? "Par" : "Impar");
    printf("Control de flujo: %s\n", (UartHandle.Init.HwFlowCtl == UART_HWCONTROL_NONE) ? "Deshabilitado" : "Habilitado");
    printf("Modo: %s\n", (UartHandle.Init.Mode == UART_MODE_TX) ? "Transmisión" : (UartHandle.Init.Mode == UART_MODE_RX) ? "Recepción" : "Transmisión y Recepción");
    printf("Oversampling: %d\n", (UartHandle.Init.OverSampling == UART_OVERSAMPLING_16) ? 16 : 8);
}

static void uartErrorHandler() {
	/* Turn LED3 on */
	HAL_GPIO_WritePin(GPIOB, GPIO_PIN_14, GPIO_PIN_SET );
	while (1) {
	}
}

